language: node_js
sudo: required
services:
  - docker
branches:
  only:
    - main
cache:
  directories:
    - travis-build
#     - packages/*/node_modules
#     - packages/*/lib
  #   - $TRAVIS_BUILD_DIR/.github
  #   - $TRAVIS_BUILD_DIR/aggregated-translations
  #   - $TRAVIS_BUILD_DIR/packages
  #   - $TRAVIS_BUILD_DIR/dev-site-config
  #   - $TRAVIS_BUILD_DIR/tests
  #   - $TRAVIS_BUILD_DIR/.nvmrc
  #   - $TRAVIS_BUILD_DIR/.nvmrc
before_install:
  - npm run clean
jobs:
  include:
    # - stage: install
    #   script: ''
    - stage: danger lint jest and compile
      # before_install: skip
      # install: skip
      script:
        # - npm run danger
        # - npm run lint
        # - npm run jest
        - rm -rf ./travis-build
        - npm run compile:prod -- --env.disableAggregateThemes --output-path $TRAVIS_BUILD_DIR/travis-build/default
        # - npm run compile:lowlight -- --env.disableAggregateThemes --output-path $TRAVIS_BUILD_DIR/travis-build/lowlight
        # - npm run compile:fusion -- --env.disableAggregateThemes --output-path $TRAVIS_BUILD_DIR/travis-build/fusion
        - ls ./travis-build -al
    # - stage: compile
    #   name: default theme
    #   before_install: skip
    #   install: skip
    #   script:
    #     - npm run postinstall
    #     - npm run compile:prod -- --env.disableAggregateThemes --output-path $TRAVIS_BUILD_DIR/build/default
    # - name: lowlight theme
    #   before_install: skip
    #   script: npm run compile:lowlight -- --env.disableAggregateThemes --output-path $TRAVIS_BUILD_DIR/build/lowlight
    # - name: fusion theme
    #   before_install: skip
    #   install: skip
    #   script:
    #     - npm run postinstall
    #     - npm run compile:fusion -- --env.disableAggregateThemes --output-path $TRAVIS_BUILD_DIR/build/fusion
    # - stage: compile
    #   before_install: skip
    #   install: skip
    #   script:
    #     - npm run postinstall
    #     - npm run compile:prod -- --env.disableAggregateThemes --output-path $TRAVIS_BUILD_DIR/travis-build/default
    #     - npm run compile:lowlight -- --env.disableAggregateThemes --output-path $TRAVIS_BUILD_DIR/travis-build/lowlight
    #     - npm run compile:fusion -- --env.disableAggregateThemes --output-path $TRAVIS_BUILD_DIR/travis-build/fusion
    # - stage: compile - default theme
    #   script: travis_wait docker-compose run test-ci npm run compile:prod -- --env.disableAggregateThemes
    - stage: wdio - default theme
      name: tiny
      before_install: skip
      install: skip
      script:
        - docker-compose up -d standalone-chrome
        - CI=TRUE WDIO_BAIL=TRUE SITE=$TRAVIS_BUILD_DIR/travis-build/default FORM_FACTOR=tiny npm run wdio-default
    - name: small
      before_install: skip
      install: skip
      script:
        - docker-compose up -d standalone-chrome
        - CI=TRUE WDIO_BAIL=TRUE SITE=$TRAVIS_BUILD_DIR/travis-build/default FORM_FACTOR=small npm run wdio-default
    - name: medium
      before_install: skip
      install: skip
      script:
        - docker pull selenium/standalone-chrome:3.14.0-helium
        - docker run -v /dev/shm:/dev/shm -e TZ=America/Chicago -d -p 4444:4444 selenium/standalone-chrome:3.14.0-helium
        - WDIO_BAIL=TRUE SITE=$TRAVIS_BUILD_DIR/travis-build/default FORM_FACTOR=medium npm run wdio-default
    # - name: medium
    #   script: FORM_FACTOR=medium test-ci
    # - name: large
    #   script: FORM_FACTOR=large test-ci
    # - name: huge
    #   script: FORM_FACTOR=huge test-ci
    # - name: enormous
    #   script: travis_wait docker-compose run -e FORM_FACTOR=enormous test-ci
    # - stage: compile - lowlight theme
    #   script: travis_wait docker-compose run test-ci npm run compile:lowlight
    # - stage: wdio - lowlight theme
    #   name: tiny
    #   script: travis_wait docker-compose run -e FORM_FACTOR=tiny test-ci sh -c 'npm run wdio-lowlight'
    # - name: small
    #   script: travis_wait docker-compose run -e FORM_FACTOR=small test-ci sh -c 'npm run wdio-lowlight'
    # - name: medium
    #   script: travis_wait docker-compose run -e FORM_FACTOR=medium test-ci sh -c 'npm run wdio-lowlight'
    # - name: large
    #   script: travis_wait docker-compose run -e FORM_FACTOR=large test-ci sh -c 'npm run wdio-lowlight'
    # - name: huge
    #   script: travis_wait docker-compose run -e FORM_FACTOR=huge test-ci sh -c 'npm run wdio-lowlight'
    # - name: enormous
    #   script: travis_wait docker-compose run -e FORM_FACTOR=enormous test-ci sh -c 'npm run wdio-lowlight'
    # - stage: compile - fusion theme
    #   script: travis_wait docker-compose run test-ci npm run compile:fusion
    # - stage: wdio - fusion theme
    #   name: tiny
    #   script: travis_wait docker-compose run -e THEME=orion-fusion-theme -e FORM_FACTOR=tiny test-ci
    # - name: small
    #   script: travis_wait docker-compose run -e THEME=orion-fusion-theme -e FORM_FACTOR=small test-ci
    # - name: medium
    #   script: travis_wait docker-compose run -e THEME=orion-fusion-theme -e FORM_FACTOR=medium test-ci
    # - name: large
    #   script: travis_wait docker-compose run -e THEME=orion-fusion-theme -e FORM_FACTOR=large test-ci
    # - name: huge
    #   script: travis_wait docker-compose run -e THEME=orion-fusion-theme -e FORM_FACTOR=huge test-ci
    # - name: enormous
    #   script: travis_wait docker-compose run -e THEME=orion-fusion-theme -e FORM_FACTOR=enormous test-ci
    - stage: deploy
      script: skip
      before_deploy:
        - TERRA_DEV_SITE_NEW_RELIC_LICENSE_KEY='c494ac44c8' TERRA_DEV_SITE_NEW_RELIC_APPLICATION_ID='142450088' TERRA_DEV_SITE_PUBLIC_PATH='/terra-core/' npm run compile:prod
      deploy:
        provider: pages
        skip_cleanup: true
        github_token: $GITHUB_TOKEN # Set in travis-ci.com dashboard
        local_dir: $TRAVIS_BUILD_DIR/build
        on:
          branch: main
stages:
  # - install
  - danger lint jest and compile
  # - compile
  # - compile - default theme
  - wdio - default theme
  # - compile - lowlight theme
  # - wdio - lowlight theme
  # - compile - fusion theme
  # - wdio - fusion theme
  - name: deploy
    if: type != pull_request
  # - clean up cache
